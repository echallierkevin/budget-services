<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RH ‚Äì Budgets par Projets</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --muted:#717274;
      --text:#111827;
      --accent:#FDC300;
      --danger:#ef4444;
      --border:#e5e7eb;
      --progress-bg:#f3f4f6;
      --ok:#16a34a;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    h1,h2{margin:0 0 .5rem}
    h1{font-size:1.35rem}
    h2{font-size:1.1rem;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px}
    .grid{display:grid;gap:16px}
    .grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.grid-cols-2{grid-template-columns:1fr}}
    label{display:block;margin:0 0 6px;color:var(--muted)}
    input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text)}
    input[type="date"]{padding:8px 10px}
    input:invalid{outline:2px solid rgba(239,68,68,.2)}
    button{cursor:pointer;font-weight:700;border:1px solid transparent;background:var(--accent);color:#3b2c00}
    button:disabled{opacity:.6;cursor:not-allowed}
    button.ghost{background:#fff;border-color:var(--border)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);background:#fff;position:sticky;top:0;z-index:1}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media (max-width:720px){.kpis{grid-template-columns:1fr 1fr}}
    .kpi{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px}
    .kpi .label{color:var(--muted);font-size:.9rem}
    .kpi .value{font-size:1.2rem;font-weight:700;margin-top:6px}
    .hr{height:1px;background:var(--border);margin:14px 0}
    .hint{color:var(--muted)}
    .progress{height:10px;background:var(--progress-bg);border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--accent)}
    .badge{display:inline-flex;gap:6px;padding:4px 8px;border-radius:999px;font-weight:600;font-size:.85rem;border:1px solid rgba(0,0,0,.08)}
    .ok{background:rgba(34,197,94,.10);color:#166534}
    .watch{background:rgba(245,158,11,.10);color:#92400e}
    .over{background:rgba(239,68,68,.10);color:#991b1b}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:40px;border-radius:6px}
    .brand-name{font-weight:800;color:#0f172a}

    /* Historique */
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .toolbar .spacer{flex:1}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff;color:#0f172a;font-weight:700}
    .summary{display:flex;justify-content:flex-end;color:var(--muted);font-size:.9rem;margin-top:8px}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.08);
      padding:10px 12px;border-radius:12px;display:none;gap:10px;align-items:center;z-index:60}
    .toast.show{display:flex;animation:fadein .15s ease}
    .toast .dot{width:10px;height:10px;border-radius:999px;background:var(--ok)}
    @keyframes fadein{from{opacity:.5;transform:translateY(6px)} to{opacity:1;transform:none}}

    /* ==== Bouton outils (menu compact) ==== */
    .tools{position:relative}
    .tools button{padding:8px 10px;font-size:.9rem;background:#fff;border:1px solid var(--border);color:#0f172a}
    .tools .label{display:none}
    @media (min-width:760px){ .tools .label{display:inline} }
    .menu{position:absolute;top:calc(100% + 8px);right:0;background:#fff;border:1px solid var(--border);border-radius:12px;
      box-shadow:0 12px 32px rgba(0,0,0,.08);min-width:230px;display:none;z-index:10;padding:6px}
    .menu.open{display:block}
    .menu button{width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;border-radius:10px}
    .menu button:hover{background:#f9fafb}
    .menu small{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <img
          src="https://cevitalspa.sharepoint.com/sites/OXXO-Portail/_api/siteiconmanager/getsitelogo?type=%271%27&hash=638888580205157645"
          alt="Logo" onerror="this.style.display='none'"/>
        <div>
          <div class="brand-name"><span id="svcTitle">RH</span> ‚Äì Budgets par Projets</div>
          <div class="hint">Cr√©er des projets, d√©finir les budgets, saisir des d√©penses</div>
        </div>
      </div>
      <div class="spacer"></div>
      <label class="hint" for="yearSelect">Exercice</label>
      <select id="yearSelect" style="min-width:180px"></select>

      <!-- Outils (menu compact) -->
      <div class="tools" id="tools">
        <button id="toolsBtn" aria-expanded="false" aria-haspopup="true" title="Outils">
          ‚ãØ <span class="label">Outils</span>
        </button>
        <div class="menu" id="toolsMenu" role="menu" aria-label="Outils">
          <button id="exportJsonBtn" role="menuitem">Exporter JSON <small>(toutes ann√©es)</small></button>
          <button id="importJsonBtn" role="menuitem">Importer JSON‚Ä¶</button>
        </div>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <div class="hr"></div>

    <div class="kpis">
      <div class="kpi"><div class="label">Budget (service)</div><div class="value" id="kpiBudget">‚Äì</div></div>
      <div class="kpi"><div class="label">D√©penses (service)</div><div class="value" id="kpiSpent">‚Äì</div></div>
      <div class="kpi"><div class="label">Reste</div><div class="value" id="kpiLeft">‚Äì</div></div>
      <div class="kpi"><div class="label">% utilis√©</div><div class="value" id="kpiUsed">‚Äì</div></div>
    </div>

    <div class="hr"></div>

    <div class="grid grid-cols-2">
      <div class="card">
        <h2>Ajouter / modifier un projet</h2>
        <div class="row">
          <div style="flex:1">
            <label for="projectName">Nom du projet</label>
            <input id="projectName" placeholder="Ex. ERP, Modernisation poste, ..." required />
          </div>
          <div style="width:220px;max-width:100%">
            <label for="projectBudget">Budget (‚Ç¨)</label>
            <input id="projectBudget" type="number" min="0" step="0.01" placeholder="Ex. 12000" required />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="saveProjectBtn">Enregistrer le projet</button>
          <button id="resetProjectBtn" class="ghost">R√©initialiser le formulaire</button>
        </div>
      </div>

      <div class="card">
        <h2>Saisir une d√©pense</h2>
        <div class="row">
          <div style="flex:1">
            <label for="expenseProject">Projet</label>
            <select id="expenseProject" required></select>
          </div>
          <div style="width:180px;max-width:100%">
            <label for="expenseAmount">Montant (‚Ç¨)</label>
            <input id="expenseAmount" type="number" min="0.01" step="0.01" placeholder="Ex. 500" required />
          </div>
          <div style="width:180px;max-width:100%">
            <label for="expenseDate">Date</label>
            <input id="expenseDate" type="date" required />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="addExpenseBtn" disabled>Ajouter la d√©pense</button>
          <span class="hint">Astuce : Entr√©e dans ‚ÄúMontant‚Äù valide.</span>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Projets du service</h2>
      <table>
        <thead>
          <tr>
            <th>Projet</th>
            <th>Budget</th>
            <th>D√©penses</th>
            <th>Reste</th>
            <th>Avancement</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="projectsTbody"></tbody>
      </table>
      <div class="hint">Astuce : ‚úèÔ∏è charge le projet, üóëÔ∏è supprime le projet.</div>
    </div>

    <!-- Historique des d√©penses -->
    <div class="card" style="margin-top:16px">
      <div class="row">
        <h2>Historique des d√©penses (<span id="histYear">‚Äî</span>)</h2>
        <div class="spacer"></div>
        <span class="pill">Service : <strong id="histService">RH</strong></span>
      </div>
      <div class="toolbar">
        <input id="histSearch" placeholder="Rechercher (projet)..." style="flex:1; min-width:240px" />
        <select id="histRange" style="width:auto">
          <option value="30">Derniers 30 jours</option>
          <option value="90">Derniers 90 jours</option>
          <option value="all" selected>Toute l'ann√©e</option>
        </select>
        <select id="histSort" style="width:auto">
          <option value="createdAt_desc">Tri : Ajout√© le ‚Üì</option>
          <option value="createdAt_asc">Tri : Ajout√© le ‚Üë</option>
          <option value="amount_desc">Tri : Montant ‚Üì</option>
          <option value="amount_asc">Tri : Montant ‚Üë</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Projet</th>
            <th>Montant</th>
            <th>Ajout√© le</th>
          </tr>
        </thead>
        <tbody id="histTbody"></tbody>
      </table>
      <div id="histSummary" class="summary">‚Äî</div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <span class="dot"></span><span id="toastMsg">Action effectu√©e.</span>
  </div>

  <script>
  (function(){
    // =====================================================================
    //            REMOTE JSON STORE (Global budgets.json)
    // =====================================================================
    // üîß A METTRE A JOUR : URL absolue vers ton fichier JSON
    const STORE_URL = "https://echallierkevin.github.io/budget-services/budgets.json"; // <-- change-moi

    // Optionnel: si ton serveur renvoie ETag, on l'utilise pour If-Match
    let __etag = null;
    let __cache = null; // { years: { ... } }

    async function fetchJson(url){
      const res = await fetch(url, { cache: 'no-store' });
      if(res.status === 404) return { ok:false, status:404 };
      if(!res.ok) throw new Error('GET failed '+res.status);
      const et = res.headers.get('ETag');
      __etag = et;
      return { ok:true, json: await res.json() };
    }
    async function putJson(url, data){
      const headers = { 'Content-Type':'application/json' };
      if(__etag) headers['If-Match'] = __etag; // si dispo
      const res = await fetch(url, { method:'PUT', headers, body: JSON.stringify(data) });
      if(res.status===412){ // Precondition Failed -> ETag conflict
        throw new Error('CONFLICT');
      }
      if(!res.ok) throw new Error('PUT failed '+res.status);
      const et = res.headers.get('ETag');
      if(et) __etag = et;
      return true;
    }
    async function ensureFileExists(){
      // Si 404, on tente de cr√©er un fichier vide via PUT
      try{
        const head = await fetch(STORE_URL, { method:'HEAD', cache:'no-store' });
        if(head.status===404){
          await putJson(STORE_URL, { years:{} });
        }
      }catch(e){
        // certains serveurs n'autorisent pas HEAD -> on ignore
      }
    }
    async function storeLoadAll(){
      if(__cache) return __cache;
      const res = await fetchJson(STORE_URL);
      if(!res.ok && res.status===404){
        await ensureFileExists();
        await putJson(STORE_URL, { years:{} });
        __cache = { years:{} };
        return __cache;
      }
      __cache = res.json || { years:{} };
      if(!__cache.years) __cache = { years:{} };
      return __cache;
    }
    async function storeSaveAll(nextData){
      // gestion d'un l√©ger conflit: on retente une fois si ETag conflict
      try{
        await putJson(STORE_URL, nextData);
        __cache = nextData;
      }catch(e){
        if(e && e.message==='CONFLICT'){
          // recharger, fusion simple (on √©crase par nos modifs), puis r√©essayer
          const latest = await storeLoadAll();
          // ici on peut faire une vraie merge si besoin; pour simplet√© on remplace
          await putJson(STORE_URL, nextData);
          __cache = nextData;
        }else{
          throw e;
        }
      }
    }
    async function updateStore(mutator){
      const data = await storeLoadAll();
      const cloned = JSON.parse(JSON.stringify(data));
      await mutator(cloned);
      await storeSaveAll(cloned);
    }

    // =====================================================================
    //                        APP RH (m√™me UI)
    // =====================================================================
    const SERVICE_NAME = "RH";
    const SERVICES = ["Marketing","RH","RH","Production","Logistique"];
    const ADD_YEAR_VALUE="__add__";

    // DOM
    const svcTitle = document.getElementById('svcTitle');
    svcTitle.textContent = SERVICE_NAME;

    const yearSelect = document.getElementById('yearSelect');

    const projectName = document.getElementById('projectName');
    const projectBudget = document.getElementById('projectBudget');
    const saveProjectBtn = document.getElementById('saveProjectBtn');
    const resetProjectBtn = document.getElementById('resetProjectBtn');

    const expenseProject = document.getElementById('expenseProject');
    const expenseAmount = document.getElementById('expenseAmount');
    const expenseDate = document.getElementById('expenseDate');
    const addExpenseBtn = document.getElementById('addExpenseBtn');

    const projectsTbody = document.getElementById('projectsTbody');

    const kpiBudget = document.getElementById('kpiBudget');
    const kpiSpent = document.getElementById('kpiSpent');
    const kpiLeft = document.getElementById('kpiLeft');
    const kpiUsed = document.getElementById('kpiUsed');

    // Historique
    const histYear = document.getElementById('histYear');
    const histService = document.getElementById('histService');
    const histSearch = document.getElementById('histSearch');
    const histRange = document.getElementById('histRange');
    const histSort = document.getElementById('histSort');
    const histTbody = document.getElementById('histTbody');
    const histSummary = document.getElementById('histSummary');

    // Outils / menu
    const tools = document.getElementById('tools');
    const toolsBtn = document.getElementById('toolsBtn');
    const toolsMenu = document.getElementById('toolsMenu');
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const importJsonBtn = document.getElementById('importJsonBtn');
    const importFile = document.getElementById('importFile');

    // Toast
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    let toastTimer = null;
    function showToast(msg){
      toastMsg.textContent = msg || 'Action effectu√©e.';
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toast.classList.remove('show'), 1800);
    }

    // Utils
    const fmtEUR = new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' });
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function uuid(){ return (crypto.randomUUID ? crypto.randomUUID() : ('p-'+Date.now()+Math.random())); }
    function parseY(d){ return Number(String(d||'').slice(0,4)); }
    function fmtDate(d){ if(!d) return '‚Äî'; try{ const dt=new Date(d); return dt.toLocaleString('fr-FR'); }catch{ return d; } }

    // Helpers de donn√©es (dans la structure globale { years: { [year]: { services: { [svc]: { projects:[] } } } } })
    function ensureYearStruct(all, year){
      if(!all.years) all.years = {};
      if(!all.years[year]) all.years[year] = { year:Number(year), services:{} };
      SERVICES.forEach(s=>{
        if(!all.years[year].services[s]) all.years[year].services[s] = { projects: [] };
        const svc = all.years[year].services[s];
        svc.projects = svc.projects || [];
        svc.projects.forEach(p=> p.expenses = Array.isArray(p.expenses)?p.expenses:[]);
      });
    }
    function getYears(all){
      return Object.keys(all.years||{}).map(n=>Number(n)).sort((a,b)=>a-b);
    }
    function totalsForService(all, year){
      ensureYearStruct(all, year);
      const svc = all.years[year].services[SERVICE_NAME];
      const budget = (svc.projects||[]).reduce((a,p)=> a + Number(p.budget||0), 0);
      const spent  = (svc.projects||[]).reduce((a,p)=> a + (p.expenses||[]).reduce((x,e)=> x + Number(e.amount||0), 0), 0);
      return { budget, spent, left: budget - spent };
    }
    function totalsForProject(p){
      const spent = (p.expenses||[]).reduce((a,e)=> a + Number(e.amount||0), 0);
      const left  = Number(p.budget||0) - spent;
      const pct   = p.budget>0 ? (spent/p.budget)*100 : (spent>0?999:0);
      return { spent, left, pct };
    }
    function statusFor(pct){
      if(pct<=90) return {cls:'ok', txt:'‚úÖ OK'};
      if(pct<=100) return {cls:'watch', txt:'‚ö†Ô∏è √Ä surveiller'};
      return {cls:'over', txt:'‚ùå D√©passement'};
    }

    // UI state
    let currentYear = null;
    let allData = null; // cache m√©moire

    function setYearOptions(selected){
      const years = getYears(allData);
      yearSelect.innerHTML='';
      years.forEach(y=>{
        const opt=document.createElement('option');
        opt.value=y; opt.textContent=y;
        if(String(y)===String(selected)) opt.selected=true;
        yearSelect.appendChild(opt);
      });
      const optAdd=document.createElement('option');
      optAdd.value=ADD_YEAR_VALUE;
      optAdd.textContent="‚ûï Ajouter un exercice‚Ä¶";
      yearSelect.appendChild(optAdd);
    }

    function refreshProjectSelect(){
      const svc = allData.years[currentYear].services[SERVICE_NAME];
      expenseProject.innerHTML='';
      (svc.projects||[]).forEach(p=>{
        const opt=document.createElement('option');
        opt.value=p.id; opt.textContent=p.name; expenseProject.appendChild(opt);
      });
    }

    function render(){
      ensureYearStruct(allData, currentYear);
      const svc = allData.years[currentYear].services[SERVICE_NAME];

      // KPIs
      const t=totalsForService(allData, currentYear);
      const used = t.budget>0 ? (t.spent/t.budget)*100 : (t.spent>0?999:0);
      kpiBudget.textContent = fmtEUR.format(t.budget);
      kpiSpent.textContent  = fmtEUR.format(t.spent);
      kpiLeft.textContent   = fmtEUR.format(t.left);
      kpiUsed.textContent   = used===999?'>100%':used.toFixed(1)+' %';

      // Projets
      projectsTbody.innerHTML='';
      (svc.projects||[]).forEach(p=>{
        const {spent,left,pct} = totalsForProject(p);
        const pctClamped = Math.min(pct,100);
        const st = statusFor(pct);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.budget?fmtEUR.format(p.budget):'<span class="hint">‚Äî</span>'}</td>
          <td>${fmtEUR.format(spent)}</td>
          <td style="color:${left<0?'#991b1b':'inherit'}">${fmtEUR.format(left)}</td>
          <td style="min-width:160px">
            <div class="progress"><span style="width:${pctClamped.toFixed(1)}%"></span></div>
            <div class="hint">${pct===999?'>100%':pct.toFixed(1)+' %'}</div>
          </td>
          <td><span class="badge ${st.cls}">${st.txt}</span></td>
          <td>
            <button class="ghost" data-edit="${p.id}" title="Modifier">‚úèÔ∏è</button>
            <button class="ghost" data-del="${p.id}" title="Supprimer">üóëÔ∏è</button>
          </td>
        `;
        projectsTbody.appendChild(tr);
      });

      // Select d√©penses
      refreshProjectSelect();

      // Historique
      renderHistory();

      if(!expenseDate.value) expenseDate.value = todayISO();
      histService.textContent = SERVICE_NAME;
      histYear.textContent = String(currentYear);
    }

    function collectExpensesForYear(){
      const svc = allData.years[currentYear].services[SERVICE_NAME] || {projects:[]};
      const items = [];
      (svc.projects||[]).forEach(p=>{
        (p.expenses||[]).forEach(e=>{
          if(parseY(e.date) === currentYear){
            items.push({
              projectId: p.id,
              projectName: p.name,
              amount: Number(e.amount||0),
              date: e.date,
              createdAt: e.createdAt || e.date,
            });
          }
        });
      });
      return items;
    }
    function sortExpenses(list, mode){
      const cmp = {
        'createdAt_desc': (a,b)=> new Date(b.createdAt) - new Date(a.createdAt),
        'createdAt_asc' : (a,b)=> new Date(a.createdAt) - new Date(b.createdAt),
        'amount_desc'   : (a,b)=> b.amount - a.amount,
        'amount_asc'    : (a,b)=> a.amount - b.amount,
      }[mode] || ((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      return list.slice().sort(cmp);
    }
    function filterByRange(list, mode){
      if(mode==='all') return list;
      const days = Number(mode)||30;
      const now = new Date();
      const from = new Date(now.getFullYear(), now.getMonth(), now.getDate() - days);
      return list.filter(x => new Date(x.createdAt) >= from);
    }
    function renderHistory(){
      const q = (histSearch.value||'').trim().toLowerCase();
      let list = collectExpensesForYear();
      if(q){ list = list.filter(x => (x.projectName||'').toLowerCase().includes(q)); }
      list = filterByRange(list, histRange.value);
      list = sortExpenses(list, histSort.value);

      histTbody.innerHTML = '';
      if(list.length===0){
        histTbody.innerHTML = `<tr><td colspan="3" class="hint">Aucune d√©pense${q?' pour votre recherche':''}.</td></tr>`;
        histSummary.textContent = '0 ligne ¬∑ Total 0,00 ‚Ç¨';
        return;
      }
      let total = 0;
      list.forEach(x=>{
        total += Number(x.amount||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.projectName}</td>
          <td>${fmtEUR.format(x.amount)}</td>
          <td>${fmtDate(x.createdAt)}</td>
        `;
        histTbody.appendChild(tr);
      });
      histSummary.textContent = `${list.length} ${list.length>1?'lignes':'ligne'} ¬∑ Total ${fmtEUR.format(total)}`;
    }

    // Actions Projets
    let editingId = null;

    saveProjectBtn.addEventListener('click', async ()=>{
      const name = (projectName.value||'').trim();
      const budget = Number(projectBudget.value||0);
      if(!name){ alert('Nom de projet requis'); return; }
      if(!(budget>=0)){ alert('Budget invalide'); return; }

      await updateStore(async (next)=>{
        ensureYearStruct(next, currentYear);
        const svc = next.years[currentYear].services[SERVICE_NAME];
        if(editingId){
          const p = (svc.projects||[]).find(x=>x.id===editingId);
          if(p){ p.name = name; p.budget = budget; }
          showToast('Projet mis √† jour.');
        }else{
          (svc.projects = svc.projects || []).push({ id: uuid(), name, budget, expenses: [] });
          showToast('Projet ajout√©.');
        }
      }).catch(err=>{
        console.error(err);
        alert("Impossible d'enregistrer (serveur).");
      });

      allData = await storeLoadAll();
      editingId = null;
      projectName.value=''; projectBudget.value='';
      render();
    });

    resetProjectBtn.addEventListener('click', ()=>{ editingId=null; projectName.value=''; projectBudget.value=''; });

    projectsTbody.addEventListener('click', async (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;

      const svc = allData.years[currentYear].services[SERVICE_NAME];

      if(t.dataset.edit){
        const p = (svc.projects||[]).find(x=>x.id===t.dataset.edit);
        if(p){ editingId = p.id; projectName.value=p.name; projectBudget.value=p.budget; window.scrollTo({top:0, behavior:'smooth'}); }
      }
      if(t.dataset.del){
        const p = (svc.projects||[]).find(x=>x.id===t.dataset.del);
        if(!p) return;
        if(!confirm(`Supprimer le projet ¬´ ${p.name} ¬ª ?`)) return;

        await updateStore(async (next)=>{
          ensureYearStruct(next, currentYear);
          const s2 = next.years[currentYear].services[SERVICE_NAME];
          s2.projects = (s2.projects||[]).filter(x=>x.id!==t.dataset.del);
        }).catch(err=>{ console.error(err); alert("Suppression impossible (serveur)."); });

        allData = await storeLoadAll();
        render();
        showToast('Projet supprim√©.');
      }
    });

    // D√©penses
    function updateExpenseButtonState(){
      const valid =
        expenseProject.value &&
        Number(expenseAmount.value) > 0 &&
        /\d{4}-\d{2}-\d{2}/.test(expenseDate.value||'');
      addExpenseBtn.disabled = !valid;
    }
    expenseProject.addEventListener('change', updateExpenseButtonState);
    expenseAmount.addEventListener('input', updateExpenseButtonState);
    expenseDate.addEventListener('input', updateExpenseButtonState);

    addExpenseBtn.addEventListener('click', addExpense);
    expenseAmount.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addExpense(); }});
    async function addExpense(){
      const pid = expenseProject.value;
      const amt = Number(expenseAmount.value||0);
      const dt  = expenseDate.value || todayISO();

      if(!pid){ alert('S√©lectionnez un projet'); return; }
      if(!(amt>0)){ alert('Montant invalide (>0)'); return; }
      if(!/\d{4}-\d{2}-\d{2}/.test(dt)){ alert('Date invalide'); return; }

      await updateStore(async (next)=>{
        ensureYearStruct(next, currentYear);
        const svc = next.years[currentYear].services[SERVICE_NAME];
        const p = (svc.projects||[]).find(x=>x.id===pid);
        if(!p) throw new Error('Projet introuvable');
        (p.expenses = p.expenses || []).push({ amount: amt, date: dt, createdAt: new Date().toISOString() });
      }).catch(err=>{
        console.error(err);
        alert("Ajout impossible (serveur).");
      });

      allData = await storeLoadAll();
      expenseAmount.value='';
      updateExpenseButtonState();
      render();
      showToast('D√©pense ajout√©e.');
      expenseAmount.focus();
    }

    // Changement d'ann√©e
    yearSelect.addEventListener('change', async ()=>{
      if(yearSelect.value===ADD_YEAR_VALUE){
        const y = prompt("Nouvel exercice (YYYY) :", String(new Date().getFullYear()+1));
        const ny = parseInt(y||'',10);
        if(!ny || ny<2000 || ny>9999){ return; }
        await updateStore(async (next)=>{ ensureYearStruct(next, ny); }).catch(err=>{
          console.error(err); alert("Cr√©ation d'exercice impossible (serveur).");
        });
        allData = await storeLoadAll();
        setYearOptions(ny);
        currentYear = ny;
        render();
      }else{
        currentYear = Number(yearSelect.value);
        render();
      }
    });

    // Historique interactions
    histSearch.addEventListener('input', renderHistory);
    histRange.addEventListener('change', renderHistory);
    histSort.addEventListener('change', renderHistory);

    // Menu Outils
    function openMenu(){
      toolsMenu.classList.add('open');
      toolsBtn.setAttribute('aria-expanded','true');
      document.addEventListener('click', outsideClose, { capture:true });
      document.addEventListener('keydown', escClose);
    }
    function closeMenu(){
      toolsMenu.classList.remove('open');
      toolsBtn.setAttribute('aria-expanded','false');
      document.removeEventListener('click', outsideClose, { capture:true });
      document.removeEventListener('keydown', escClose);
    }
    function outsideClose(e){ if(!tools.contains(e.target)) closeMenu(); }
    function escClose(e){ if(e.key==='Escape') closeMenu(); }
    toolsBtn.addEventListener('click', ()=>{ toolsMenu.classList.contains('open') ? closeMenu() : openMenu(); });

    // Export / Import (menu)
    exportJsonBtn.addEventListener('click', async ()=>{
      try{
        const data = await storeLoadAll();
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        const ts=new Date().toISOString().replace(/[:.]/g,'-');
        a.download=`budgets-multi-${ts}.json`;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(a.href),1500);
        showToast('Export JSON g√©n√©r√©.');
      }catch(e){ alert('Export impossible.'); }
      closeMenu();
    });

    importJsonBtn.addEventListener('click', ()=>{ importFile.click(); closeMenu(); });
    importFile.addEventListener('change', async ()=>{
      const f = importFile.files && importFile.files[0];
      if(!f) return;
      const reader=new FileReader();
      reader.onload=async ()=>{
        try{
          const json = JSON.parse(String(reader.result||'{}'));
          // Merge simple: on remplace tout (le plus simple & coh√©rent)
          await storeSaveAll(json && json.years ? json : { years: json.years ? json.years : {} });
          allData = await storeLoadAll();
          setYearOptions(currentYear);
          render();
          showToast('Import termin√©.');
        }catch(e){ console.error(e); alert('Import JSON invalide/serveur indisponible.'); }
        importFile.value='';
      };
      reader.readAsText(f);
    });

    // Init
    (async function init(){
      try{
        allData = await storeLoadAll();
      }catch(e){
        console.error(e);
        alert("Le serveur de donn√©es est indisponible. Lecture seule.");
        allData = { years:{} };
      }
      let years = getYears(allData);
      if(years.length===0){
        const y = new Date().getFullYear();
        await updateStore(async (next)=>{ ensureYearStruct(next, y); }).catch(()=>{});
        allData = await storeLoadAll();
        years = getYears(allData);
      }
      const urlYear = new URLSearchParams(location.search).get('year');
      currentYear = urlYear ? Number(urlYear) :
        (years.includes(new Date().getFullYear()) ? new Date().getFullYear() : years[years.length-1]);
      setYearOptions(currentYear);
      render();
      if(!expenseDate.value) expenseDate.value = todayISO();
      const valid = expenseProject.value && Number(expenseAmount.value)>0 && /\d{4}-\d{2}-\d{2}/.test(expenseDate.value||'');
      addExpenseBtn.disabled = !valid;
    })();
  })();
  </script>
</body>
</html>
