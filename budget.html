<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi Budgets par Service</title>
  <style>
    :root{
      --bg:#ffffff;            /* fond blanc */
      --panel:#ffffff;         /* cartes blanches */
      --muted:#717274;         /* gris brand */
      --text:#111827;          /* texte sombre */
      --accent:#FDC300;        /* jaune brand */
      --warn:#f59e0b;
      --danger:#ef4444;
      --card:#ffffff;
      --border:#e5e7eb;        /* gris clair pour bordures sur fond blanc */
      --progress-bg:#f3f4f6;   /* arrière-plan des barres */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    h1,h2{margin:0 0 .5rem}
    h1{font-size:1.35rem}
    h2{font-size:1.1rem;color:var(--muted)}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}

    .grid{display:grid;gap:16px}
    .grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:720px){.grid-cols-2{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .spacer{flex:1}
    label{display:block;margin:0 0 6px;color:var(--muted)}
    select,input,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#ffffff;color:var(--text)}
    input[type="date"]{padding:8px 10px}
    button{cursor:pointer;border:1px solid transparent;background:var(--accent);color:#3b2c00;font-weight:700}
    button.ghost{background:#ffffff;border-color:var(--border);color:var(--text)}
    button.danger{background:var(--danger);color:#ffffff;border:none}
    button:disabled{opacity:.6;cursor:not-allowed}

    table{width:100%;border-collapse:collapse;background:#ffffff}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);font-weight:600}
    tbody tr:hover{background:#fafafa}

    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media (max-width:720px){.kpis{grid-template-columns:1fr 1fr}}
    .kpi{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .kpi .label{color:var(--muted);font-size:.9rem}
    .kpi .value{font-size:1.2rem;font-weight:700;margin-top:6px;color:#0f172a}

    .progress{height:10px;background:var(--progress-bg);border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--accent);width:0}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-weight:600;font-size:.85rem}
    .ok{background:rgba(34,197,94,.10);color:#166534;border:1px solid rgba(34,197,94,.35)}
    .watch{background:rgba(245,158,11,.10);color:#92400e;border:1px solid rgba(245,158,11,.35)}
    .over{background:rgba(239,68,68,.10);color:#991b1b;border:1px solid rgba(239,68,68,.35)}

    .hr{height:1px;background:var(--border);margin:14px 0}
    .hint{color:var(--muted);font-size:.9rem}
    .footer{color:var(--muted);font-size:.85rem;margin-top:16px}

    .title-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:40px;width:auto;display:block;border-radius:6px}
    .brand-name{font-weight:800;letter-spacing:.2px;color:#0f172a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title-row">
      <div class="brand">
        <!-- Logo : masqué automatiquement si non accessible -->
        <img
          src="https://cevitalspa.sharepoint.com/sites/OXXO-Portail/_api/siteiconmanager/getsitelogo?type=%271%27&hash=638888580205157645"
          alt="Logo"
          onerror="this.style.display='none'"
        />
        <div>
          <div class="brand-name">Outil Budget Services</div>
          <div class="hint">Suivi par exercice</div>
        </div>
      </div>
      <div class="spacer"></div>
      <label for="yearSelect" class="hint">Exercice</label>
      <select id="yearSelect" style="width:auto;min-width:180px"></select>
    </div>

    <div class="hr"></div>

    <!-- Indicateurs globaux -->
    <div class="kpis" id="globalKpis">
      <div class="kpi"><div class="label">Budget global</div><div class="value" id="kpiBudget">–</div></div>
      <div class="kpi"><div class="label">Dépenses globales</div><div class="value" id="kpiSpent">–</div></div>
      <div class="kpi"><div class="label">Reste disponible</div><div class="value" id="kpiLeft">–</div></div>
      <div class="kpi"><div class="label">% utilisé</div><div class="value" id="kpiUsed">–</div></div>
    </div>

    <div class="hr"></div>

    <div class="grid grid-cols-2">
      <!-- Formulaire Budget -->
      <div class="card">
        <h2>Budget annuel par service</h2>
        <div class="row">
          <div style="flex:1">
            <label for="serviceBudget">Service</label>
            <select id="serviceBudget"></select>
          </div>
          <div style="width:220px;max-width:100%">
            <label for="budgetAmount">Budget annuel (€)</label>
            <input id="budgetAmount" type="number" min="0" step="0.01" placeholder="Ex. 10000" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="saveBudgetBtn">Enregistrer le budget</button>
        </div>
      </div>

      <!-- Formulaire Dépenses -->
      <div class="card">
        <h2>Saisie des dépenses</h2>
        <div class="row">
          <div style="flex:1">
            <label for="serviceExpense">Service</label>
            <select id="serviceExpense"></select>
          </div>
          <div style="width:180px;max-width:100%">
            <label for="expenseAmount">Montant (€)</label>
            <input id="expenseAmount" type="number" min="0" step="0.01" placeholder="Ex. 500" />
          </div>
          <div style="width:180px;max-width:100%">
            <label for="expenseDate">Date</label>
            <input id="expenseDate" type="date" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="addExpenseBtn">Ajouter la dépense</button>
        </div>
      </div>
    </div>

    <!-- Suivi par service -->
    <div class="card" style="margin-top:16px">
      <h2>Suivi par service</h2>
      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Budget alloué</th>
            <th>Dépenses cumulées</th>
            <th>Reste</th>
            <th>Avancement</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody id="summaryTbody"></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Export / Import</h2>
      <div class="row">
        <button id="exportBtn" class="ghost">Exporter (JSON)</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importBtn" class="ghost">Importer (JSON)</button>
        <button id="resetBtn" class="danger">Réinitialiser toutes les données</button>
        <div class="spacer"></div>
        <span class="hint">Les données sont stockées localement (localStorage).</span>
      </div>
    </div>

    <div class="footer">
      <div>Services : Marketing • RH • DSI • Production • Logistique</div>
      <div>Statuts : ≤ 90 % ✅ OK · 90–100 % ⚠️ À surveiller · &gt; 100 % ❌ Dépassement.</div>
    </div>
  </div>

  <script>
  (function(){
    // --- Constantes ---
    const SERVICES = ["Marketing","RH","DSI","Production","Logistique"];
    const LS_PREFIX = "bt-state-";
    const ADD_YEAR_VALUE = "__add__";

    // DOM
    const yearSelect = document.getElementById('yearSelect');

    const serviceBudget = document.getElementById('serviceBudget');
    const budgetAmount = document.getElementById('budgetAmount');
    const saveBudgetBtn = document.getElementById('saveBudgetBtn');

    const serviceExpense = document.getElementById('serviceExpense');
    const expenseAmount = document.getElementById('expenseAmount');
    const expenseDate = document.getElementById('expenseDate');
    const addExpenseBtn = document.getElementById('addExpenseBtn');

    const summaryTbody = document.getElementById('summaryTbody');

    const kpiBudget = document.getElementById('kpiBudget');
    const kpiSpent = document.getElementById('kpiSpent');
    const kpiLeft = document.getElementById('kpiLeft');
    const kpiUsed = document.getElementById('kpiUsed');

    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const resetBtn = document.getElementById('resetBtn');

    // Utils
    const fmtEUR = new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' });
    const todayISO = () => new Date().toISOString().slice(0,10);
    const parseYear = y => Number(String(y).slice(0,4));

    function getKey(year){ return LS_PREFIX + String(year); }

    function loadYears(){
      const years = [];
      for(let i=0;i<localStorage.length;i++){
        const key = localStorage.key(i);
        if(key && key.startsWith(LS_PREFIX)){
          const y = parseInt(key.replace(LS_PREFIX,''),10);
          if(!Number.isNaN(y)) years.push(y);
        }
      }
      if(years.length===0){ years.push(new Date().getFullYear()); }
      years.sort((a,b)=>a-b);
      return years;
    }

    function defaultState(year){
      return { year, budgets: {}, expenses: [] };
    }

    function loadState(year){
      const raw = localStorage.getItem(getKey(year));
      if(!raw){
        const st = defaultState(year);
        localStorage.setItem(getKey(year), JSON.stringify(st));
        return st;
      }
      try{ return JSON.parse(raw); } catch(e){
        const st = defaultState(year);
        localStorage.setItem(getKey(year), JSON.stringify(st));
        return st;
      }
    }

    function saveState(state){
      localStorage.setItem(getKey(state.year), JSON.stringify(state));
    }

    function setYearOptions(selected){
      const years = loadYears();
      yearSelect.innerHTML = '';
      years.forEach(y=>{
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        if(String(y)===String(selected)) opt.selected = true;
        yearSelect.appendChild(opt);
      });
      // Option "Ajouter un exercice…"
      const optAdd = document.createElement('option');
      optAdd.value = ADD_YEAR_VALUE;
      optAdd.textContent = "➕ Ajouter un exercice…";
      yearSelect.appendChild(optAdd);
    }

    // Agrégations
    function sumExpensesFor(state, service){
      return state.expenses
        .filter(e=> e.service===service && parseYear(e.date)===state.year)
        .reduce((a,b)=> a + Number(b.amount||0), 0);
    }
    function totalBudget(state){
      return Object.values(state.budgets).reduce((a,b)=> a + Number(b||0), 0);
    }
    function totalExpenses(state){
      return SERVICES.reduce((acc,s)=> acc + sumExpensesFor(state,s), 0);
    }

    function statusFor(percent){
      if(percent <= 90) return { cls:'ok', label:'✅ OK' };
      if(percent <= 100) return { cls:'watch', label:'⚠️ À surveiller' };
      return { cls:'over', label:'❌ Dépassement' };
    }

    // Rendu
    function renderSummary(state){
      summaryTbody.innerHTML = '';
      SERVICES.forEach(s=>{
        const budget = Number(state.budgets[s]||0);
        const spent = sumExpensesFor(state, s);
        const left = budget - spent;
        const pct = budget > 0 ? (spent / budget) * 100 : (spent>0 ? 999 : 0);
        const pctClamped = Math.min(pct, 100);
        const st = statusFor(pct);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s}</td>
          <td>${budget?fmtEUR.format(budget):'<span class="hint">—</span>'}</td>
          <td>${fmtEUR.format(spent)}</td>
          <td style="color:${left<0?'#991b1b':'inherit'}">${fmtEUR.format(left)}</td>
          <td style="min-width:160px">
            <div class="progress"><span style="width:${pctClamped.toFixed(1)}%"></span></div>
            <div class="hint">${pct===999?'>100%':pct.toFixed(1)+' %'}</div>
          </td>
          <td><span class="badge ${st.cls}">${st.label}</span></td>
        `;
        summaryTbody.appendChild(tr);
      });
    }

    function renderKPIs(state){
      const tb = totalBudget(state);
      const te = totalExpenses(state);
      const left = tb - te;
      const used = tb>0 ? (te/tb)*100 : (te>0?999:0);
      kpiBudget.textContent = fmtEUR.format(tb);
      kpiSpent.textContent = fmtEUR.format(te);
      kpiLeft.textContent = fmtEUR.format(left);
      kpiUsed.textContent = used===999?'>100%':used.toFixed(1)+' %';
    }

    function rerender(year){
      const state = loadState(year);
      renderSummary(state);
      renderKPIs(state);
      if(!expenseDate.value) expenseDate.value = todayISO();
    }

    function populateServiceSelects(){
      [serviceBudget, serviceExpense].forEach(sel=>{
        sel.innerHTML='';
        SERVICES.forEach(s=>{
          const opt=document.createElement('option');
          opt.value=s; opt.textContent=s; sel.appendChild(opt);
        });
      });
    }

    // Actions
    saveBudgetBtn.addEventListener('click', ()=>{
      const year = Number(yearSelect.value);
      const state = loadState(year);
      const srv = serviceBudget.value;
      const amt = Number(budgetAmount.value);
      if(!srv){ alert('Choisissez un service'); return; }
      if(!(amt>=0)){ alert('Montant invalide'); return; }
      state.budgets[srv] = amt; // un budget max par service
      saveState(state);
      rerender(year);
      budgetAmount.value='';
    });

    addExpenseBtn.addEventListener('click', ()=>{
      const year = Number(yearSelect.value);
      const state = loadState(year);
      const srv = serviceExpense.value;
      const amt = Number(expenseAmount.value);
      const dt = expenseDate.value || todayISO();
      if(!srv){ alert('Choisissez un service'); return; }
      if(!(amt>0)){ alert('Saisissez un montant > 0'); return; }
      if(!/\d{4}-\d{2}-\d{2}/.test(dt)){ alert('Date invalide'); return; }
      state.expenses.push({ service:srv, amount:amt, date:dt });
      saveState(state);
      rerender(year);
      expenseAmount.value='';
    });

    // Sélection/ajout d'exercice
    yearSelect.addEventListener('change', ()=>{
      if(yearSelect.value === ADD_YEAR_VALUE){
        const y = prompt("Nouvel exercice (YYYY) :", String(new Date().getFullYear()+1));
        if(!y){ setYearOptions(loadYears().slice(-1)[0]); rerender(Number(yearSelect.value)); return; }
        const nY = parseInt(y,10);
        if(!nY || nY<2000 || nY>9999){ alert("Année invalide."); setYearOptions(loadYears().slice(-1)[0]); rerender(Number(yearSelect.value)); return; }
        if(!localStorage.getItem(getKey(nY))){
          localStorage.setItem(getKey(nY), JSON.stringify(defaultState(nY)));
        }
        setYearOptions(nY);
        rerender(nY);
      } else {
        rerender(Number(yearSelect.value));
      }
    });

    // Export : inclut tous les exercices
    function collectAll(){
      const out = { years:{} };
      loadYears().forEach(y=>{ out.years[y] = loadState(y); });
      return out;
    }

    exportBtn.addEventListener('click', ()=>{
      const data = collectAll();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      a.download = `budgets-export-${ts}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    });

    importBtn.addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', ()=>{
      const f = importFile.files && importFile.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const json = JSON.parse(String(reader.result||'{}'));
          if(json && json.years && typeof json.years === 'object'){
            Object.keys(json.years).forEach(y=>{
              const st = json.years[y];
              if(st && st.year){ localStorage.setItem(getKey(st.year), JSON.stringify(st)); }
              else { localStorage.setItem(getKey(y), JSON.stringify({ ...(st||{}), year:Number(y) })); }
            });
          } else if(json && json.year){
            localStorage.setItem(getKey(json.year), JSON.stringify(json));
          } else {
            alert('Fichier JSON non reconnu.');
            return;
          }
          setYearOptions(Number(yearSelect.value));
          rerender(Number(yearSelect.value));
          alert('Import terminé.');
        }catch(err){
          console.error(err);
          alert('Impossible de lire le JSON.');
        }
        importFile.value='';
      };
      reader.readAsText(f);
    });

    resetBtn.addEventListener('click', ()=>{
      if(!confirm('Tout supprimer (tous les exercices) ?')) return;
      const keys=[];
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i); if(k&&k.startsWith(LS_PREFIX)) keys.push(k);
      }
      keys.forEach(k=>localStorage.removeItem(k));
      const y = new Date().getFullYear();
      localStorage.setItem(getKey(y), JSON.stringify(defaultState(y)));
      setYearOptions(y);
      rerender(y);
    });

    // Init
    function init(){
      // services
      [serviceBudget, serviceExpense].forEach(sel=>{
        sel.innerHTML='';
        SERVICES.forEach(s=>{
          const opt=document.createElement('option');
          opt.value=s; opt.textContent=s; sel.appendChild(opt);
        });
      });
      const years = loadYears();
      const current = years.includes(new Date().getFullYear()) ? new Date().getFullYear() : years[years.length-1];
      setYearOptions(current);
      rerender(current);
      if(!expenseDate.value) expenseDate.value = todayISO();
    }

    init();
  })();
  </script>
</body>
</html>
