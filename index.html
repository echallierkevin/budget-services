<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AperÃ§u â€“ Budgets par Service</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --muted:#717274;
      --text:#111827;
      --accent:#FDC300;
      --danger:#ef4444;
      --border:#e5e7eb;
      --progress-bg:#f3f4f6;
      --backdrop:rgba(17,24,39,.55);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    h1,h2{margin:0 0 .5rem}
    h1{font-size:1.35rem}
    h2{font-size:1.1rem;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px}
    label{display:block;margin:0 0 6px;color:var(--muted)}
    select,button{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#0f172a}
    button{cursor:pointer;font-weight:700;border:1px solid transparent;background:var(--accent);color:#3b2c00}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media (max-width:720px){.kpis{grid-template-columns:1fr 1fr}}
    .kpi{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px}
    .kpi .label{color:var(--muted);font-size:.9rem}
    .kpi .value{font-size:1.2rem;font-weight:700;margin-top:6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{color:var(--muted)}
    .progress{height:10px;background:var(--progress-bg);border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--accent)}
    .badge{display:inline-flex;gap:6px;padding:4px 8px;border-radius:999px;font-weight:600;font-size:.85rem;border:1px solid rgba(0,0,0,.08)}
    .ok{background:rgba(34,197,94,.10);color:#166534}
    .watch{background:rgba(245,158,11,.10);color:#92400e}
    .over{background:rgba(239,68,68,.10);color:#991b1b}
    .hr{height:1px;background:var(--border);margin:14px 0}
    .hint{color:var(--muted)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:40px;border-radius:6px}
    .brand-name{font-weight:800;color:#0f172a}

    /* ==== Drawer dÃ©tail ==== */
    .overlay{position:fixed;inset:0;background:var(--backdrop);display:none;opacity:0;transition:opacity .2s ease;z-index:50}
    .overlay.open{display:block;opacity:1}
    .sheet{position:fixed;top:0;right:0;height:100%;width:min(900px,100%);background:#fff;border-left:1px solid var(--border);
      transform:translateX(100%);transition:transform .25s ease;z-index:51;display:flex;flex-direction:column}
    .overlay.open + .sheet{transform:translateX(0)}
    .sheet-head{display:flex;align-items:center;gap:12px;padding:16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:1}
    .sheet-title{font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff}
    .close-btn{background:#fff;border:1px solid var(--border)}
    .sheet-body{padding:16px;overflow:auto;height:100%}
    .kpis-row{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-bottom:12px}
    @media (max-width:720px){.kpis-row{grid-template-columns:1fr 1fr}}
    .mini-kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
    .mini-kpi .label{color:var(--muted);font-size:.85rem}
    .mini-kpi .value{font-weight:800;margin-top:4px}
    .mini-table{width:100%;border-collapse:collapse}
    .mini-table th,.mini-table td{padding:10px;border-bottom:1px solid var(--border)}
    .sheet-foot{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
    .search{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .search input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--border)}
    .ghost{background:#fff;border:1px solid var(--border)}

    /* ==== Bouton outils (menu) ==== */
    .tools{position:relative}
    .tools button{padding:8px 10px;font-size:.9rem;background:#fff;border:1px solid var(--border);color:#0f172a}
    .tools .label{display:none}
    @media (min-width:760px){ .tools .label{display:inline} }
    .menu{position:absolute;top:calc(100% + 8px);right:0;background:#fff;border:1px solid var(--border);border-radius:12px;
      box-shadow:0 12px 32px rgba(0,0,0,.08);min-width:230px;display:none;z-index:10;padding:6px}
    .menu.open{display:block}
    .menu button{width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;border-radius:10px}
    .menu button:hover{background:#f9fafb}
    .menu small{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <img
          src="https://cevitalspa.sharepoint.com/sites/OXXO-Portail/_api/siteiconmanager/getsitelogo?type=%271%27&hash=638888580205157645"
          alt="Logo" onerror="this.style.display='none'"/>
        <div>
          <div class="brand-name">AperÃ§u â€“ Budgets par Service</div>
          <div class="hint">Vue globale. Ouvre un panneau latÃ©ral clair pour voir les projets dâ€™un service.</div>
        </div>
      </div>
      <div class="spacer"></div>

      <!-- SÃ©lecteur d'annÃ©e -->
      <label class="hint" for="yearSelect">Exercice</label>
      <select id="yearSelect" style="min-width:180px"></select>

      <!-- Petit bouton Outils -->
      <div class="tools" id="tools">
        <button id="toolsBtn" aria-expanded="false" aria-haspopup="true" title="Outils">
          â‹¯ <span class="label">Outils</span>
        </button>
        <div class="menu" id="toolsMenu" role="menu" aria-label="Outils">
          <button id="exportJsonBtn" role="menuitem">Exporter JSON <small>(toutes annÃ©es)</small></button>
          <button id="importJsonBtn" role="menuitem">Importer JSONâ€¦</button>
        </div>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <div class="hr"></div>

    <div class="kpis">
      <div class="kpi"><div class="label">Budget global</div><div id="kpiBudget" class="value">â€“</div></div>
      <div class="kpi"><div class="label">DÃ©penses globales</div><div id="kpiSpent" class="value">â€“</div></div>
      <div class="kpi"><div class="label">Reste disponible</div><div id="kpiLeft" class="value">â€“</div></div>
      <div class="kpi"><div class="label">% utilisÃ©</div><div id="kpiUsed" class="value">â€“</div></div>
    </div>

    <div class="hr"></div>

    <div class="card">
      <h2>Services</h2>
      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Budget cumulÃ©</th>
            <th>DÃ©penses cumulÃ©es</th>
            <th>Reste</th>
            <th>Avancement</th>
            <th>Statut</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="servicesTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Drawer dÃ©tail -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>
  <aside id="sheet" class="sheet" aria-labelledby="sheetTitle" role="dialog" aria-modal="true">
    <div class="sheet-head">
      <div class="pill" id="sheetServicePill">Service</div>
      <div class="sheet-title" id="sheetTitle">DÃ©tail projets</div>
      <div class="spacer"></div>
      <button id="closeSheet" class="close-btn" aria-label="Fermer">âœ•</button>
    </div>
    <div class="sheet-body">
      <div class="search">
        <input id="searchInput" placeholder="Rechercher un projetâ€¦ (nom contient)"/>
        <button id="clearSearch" class="ghost">Effacer</button>
      </div>
      <div class="kpis-row">
        <div class="mini-kpi"><div class="label">Budget (service)</div><div class="value" id="svcKpiBudget">â€“</div></div>
        <div class="mini-kpi"><div class="label">DÃ©penses (service)</div><div class="value" id="svcKpiSpent">â€“</div></div>
        <div class="mini-kpi"><div class="label">Reste</div><div class="value" id="svcKpiLeft">â€“</div></div>
        <div class="mini-kpi"><div class="label">% utilisÃ©</div><div class="value" id="svcKpiUsed">â€“</div></div>
      </div>

      <table class="mini-table">
        <thead>
          <tr>
            <th style="width:35%">Projet</th>
            <th>Budget</th>
            <th>DÃ©penses</th>
            <th>Reste</th>
            <th>Avancement</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody id="detailTbody"></tbody>
      </table>
    </div>
    <div class="sheet-foot">
      <button id="closeSheet2" class="ghost">Fermer</button>
    </div>
  </aside>

  <script>
  (function(){
    // =====================================================================
    //            REMOTE JSON STORE (Global budgets.json)
    // =====================================================================
    // ðŸ”§ A METTRE A JOUR : URL absolue vers ton fichier JSON global
    const STORE_URL = "https://TON-DOMAINE.EXEMPLE/budgets/budgets.json"; // <-- change-moi

    // Optionnel : gestion ETag si ton serveur lâ€™envoie
    let __etag = null;
    let __cache = null; // { years: { 2025: { year:2025, services:{...} }, ... } }

    async function fetchJson(url){
      const res = await fetch(url, { cache:'no-store' });
      if(res.status===404) return { ok:false, status:404 };
      if(!res.ok) throw new Error('GET failed '+res.status);
      __etag = res.headers.get('ETag');
      return { ok:true, json: await res.json() };
    }
    async function putJson(url, data){
      const headers = { 'Content-Type':'application/json' };
      if(__etag) headers['If-Match'] = __etag;
      const res = await fetch(url, { method:'PUT', headers, body: JSON.stringify(data) });
      if(res.status===412) throw new Error('CONFLICT'); // ETag mismatch
      if(!res.ok) throw new Error('PUT failed '+res.status);
      const et = res.headers.get('ETag');
      if(et) __etag = et;
      return true;
    }
    async function ensureFileExists(){
      try{
        const head = await fetch(STORE_URL, { method:'HEAD', cache:'no-store' });
        if(head.status===404){ await putJson(STORE_URL, { years:{} }); }
      }catch(e){ /* certains serveurs nâ€™autorisent pas HEAD */ }
    }
    async function storeLoadAll(){
      if(__cache) return __cache;
      const res = await fetchJson(STORE_URL);
      if(!res.ok && res.status===404){
        await ensureFileExists();
        await putJson(STORE_URL, { years:{} });
        __cache = { years:{} };
        return __cache;
      }
      __cache = res.json || { years:{} };
      if(!__cache.years) __cache = { years:{} };
      return __cache;
    }
    async function storeSaveAll(nextData){
      try{
        await putJson(STORE_URL, nextData);
        __cache = nextData;
      }catch(e){
        if(e.message==='CONFLICT'){
          const latest = await storeLoadAll();
          // (ici tu peux coder une vraie fusion si besoin)
          await putJson(STORE_URL, nextData);
          __cache = nextData;
        }else{
          throw e;
        }
      }
    }
    async function updateStore(mutator){
      const data = await storeLoadAll();
      const cloned = JSON.parse(JSON.stringify(data));
      await mutator(cloned);
      await storeSaveAll(cloned);
    }

    // =====================================================================
    //                         LOGIQUE INDEX
    // =====================================================================
    const SERVICES = ["Marketing","RH","DSI","Production","Logistique"];
    const ADD_YEAR_VALUE = "__add__";

    // DOM liste
    const yearSelect = document.getElementById('yearSelect');
    const servicesTbody = document.getElementById('servicesTbody');
    const kpiBudget = document.getElementById('kpiBudget');
    const kpiSpent  = document.getElementById('kpiSpent');
    const kpiLeft   = document.getElementById('kpiLeft');
    const kpiUsed   = document.getElementById('kpiUsed');

    // Outils / menu
    const tools     = document.getElementById('tools');
    const toolsBtn  = document.getElementById('toolsBtn');
    const toolsMenu = document.getElementById('toolsMenu');
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const importJsonBtn = document.getElementById('importJsonBtn');
    const importFile    = document.getElementById('importFile');

    // Drawer
    const overlay = document.getElementById('overlay');
    const sheet   = document.getElementById('sheet');
    const closeSheet = document.getElementById('closeSheet');
    const closeSheet2 = document.getElementById('closeSheet2');
    const sheetServicePill = document.getElementById('sheetServicePill');
    const sheetTitle       = document.getElementById('sheetTitle');
    const detailTbody = document.getElementById('detailTbody');
    const svcKpiBudget = document.getElementById('svcKpiBudget');
    const svcKpiSpent  = document.getElementById('svcKpiSpent');
    const svcKpiLeft   = document.getElementById('svcKpiLeft');
    const svcKpiUsed   = document.getElementById('svcKpiUsed');
    const searchInput  = document.getElementById('searchInput');
    const clearSearch  = document.getElementById('clearSearch');

    // Utils
    const fmtEUR = new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' });
    function getYears(all){ return Object.keys(all.years||{}).map(n=>Number(n)).sort((a,b)=>a-b); }
    function ensureYearStruct(all, year){
      if(!all.years) all.years = {};
      if(!all.years[year]) all.years[year] = { year:Number(year), services:{} };
      SERVICES.forEach(s=>{
        if(!all.years[year].services[s]) all.years[year].services[s] = { projects:[] };
        const svc = all.years[year].services[s];
        svc.projects = svc.projects || [];
        svc.projects.forEach(p=> p.expenses = Array.isArray(p.expenses)?p.expenses:[]);
      });
    }
    function projectTotals(p){
      const spent = (p.expenses||[]).reduce((a,e)=> a + Number(e.amount||0), 0);
      const left  = Number(p.budget||0) - spent;
      const pct   = p.budget>0 ? (spent/p.budget)*100 : (spent>0?999:0);
      return { spent,left,pct };
    }
    function serviceTotals(all, year, service){
      ensureYearStruct(all, year);
      const svc = all.years[year].services[service] || {projects:[]};
      const budget = (svc.projects||[]).reduce((a,p)=> a + Number(p.budget||0), 0);
      const spent  = (svc.projects||[]).reduce((a,p)=> a + (p.expenses||[]).reduce((x,e)=> x + Number(e.amount||0), 0), 0);
      return { budget, spent, left: budget - spent };
    }
    function totalsAll(all, year){
      return SERVICES.reduce((acc,s)=>{
        const t = serviceTotals(all, year, s);
        acc.budget += t.budget;
        acc.spent  += t.spent;
        return acc;
      }, {budget:0, spent:0});
    }
    function statusFor(pct){
      if(pct<=90) return {cls:'ok', txt:'âœ… OK'};
      if(pct<=100) return {cls:'watch', txt:'âš ï¸ Ã€ surveiller'};
      return {cls:'over', txt:'âŒ DÃ©passement'};
    }

    // UI State
    let allData = { years:{} };
    let currentYear = null;
    let currentService = null;

    function setYearOptions(selected){
      const years = getYears(allData);
      yearSelect.innerHTML='';
      years.forEach(y=>{
        const opt=document.createElement('option');
        opt.value=y; opt.textContent=y;
        if(String(y)===String(selected)) opt.selected=true;
        yearSelect.appendChild(opt);
      });
      const optAdd=document.createElement('option');
      optAdd.value=ADD_YEAR_VALUE;
      optAdd.textContent="âž• Ajouter un exerciceâ€¦";
      yearSelect.appendChild(optAdd);
    }

    function renderList(){
      ensureYearStruct(allData, currentYear);
      const {budget:tb, spent:te} = totalsAll(allData, currentYear);
      const left = tb - te;
      const used = tb>0 ? (te/tb)*100 : (te>0?999:0);

      kpiBudget.textContent = fmtEUR.format(tb);
      kpiSpent.textContent  = fmtEUR.format(te);
      kpiLeft.textContent   = fmtEUR.format(left);
      kpiUsed.textContent   = used===999?'>100%':used.toFixed(1)+' %';

      servicesTbody.innerHTML='';
      SERVICES.forEach(s=>{
        const t = serviceTotals(allData, currentYear, s);
        const pct = t.budget>0 ? (t.spent/t.budget)*100 : (t.spent>0?999:0);
        const pctClamped = Math.min(pct,100);
        const st = statusFor(pct);

        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${s}</td>
          <td>${t.budget?fmtEUR.format(t.budget):'<span class="hint">â€”</span>'}</td>
          <td>${fmtEUR.format(t.spent)}</td>
          <td style="color:${t.left<0?'#991b1b':'inherit'}">${fmtEUR.format(t.left)}</td>
          <td style="min-width:160px">
            <div class="progress"><span style="width:${pctClamped.toFixed(1)}%"></span></div>
            <div class="hint">${pct===999?'>100%':pct.toFixed(1)+' %'}</div>
          </td>
          <td><span class="badge ${st.cls}">${st.txt}</span></td>
          <td><button class="open-detail" data-service="${s}">Voir dÃ©tail</button></td>
        `;
        servicesTbody.appendChild(tr);
      });
    }

    // Drawer
    function buildDetail(service){
      const svc = allData.years[currentYear].services[service] || {projects:[]};
      const t = serviceTotals(allData, currentYear, service);
      const used = t.budget>0 ? (t.spent/t.budget)*100 : (t.spent>0?999:0);
      svcKpiBudget.textContent = t.budget ? fmtEUR.format(t.budget) : 'â€”';
      svcKpiSpent.textContent  = fmtEUR.format(t.spent);
      svcKpiLeft.textContent   = fmtEUR.format(t.left);
      svcKpiUsed.textContent   = used===999?'>100%':used.toFixed(1)+' %';

      const q = (searchInput.value||'').trim().toLowerCase();
      const list = (svc.projects||[]).filter(p => !q || (p.name||'').toLowerCase().includes(q));

      detailTbody.innerHTML='';
      if(list.length===0){
        detailTbody.innerHTML = `<tr><td colspan="6" class="hint">Aucun projet${q?' pour votre recherche':''}.</td></tr>`;
        return;
      }
      list.forEach(p=>{
        const {spent,left,pct} = projectTotals(p);
        const pctClamped = Math.min(pct,100);
        const st = statusFor(pct);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.budget?fmtEUR.format(p.budget):'<span class="hint">â€”</span>'}</td>
          <td>${fmtEUR.format(spent)}</td>
          <td style="color:${left<0?'#991b1b':'inherit'}">${fmtEUR.format(left)}</td>
          <td style="min-width:160px">
            <div class="progress"><span style="width:${pctClamped.toFixed(1)}%"></span></div>
            <div class="hint">${pct===999?'>100%':pct.toFixed(1)+' %'}</div>
          </td>
          <td><span class="badge ${st.cls}">${st.txt}</span></td>
        `;
        detailTbody.appendChild(tr);
      });
    }
    function openDrawer(service){
      currentService = service;
      sheetServicePill.textContent = service;
      sheetTitle.textContent = `DÃ©tail projets â€“ ${service}`;
      searchInput.value = '';
      buildDetail(service);
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden','false');
      document.body.style.overflow='hidden';
    }
    function closeDrawer(){
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden','true');
      document.body.style.overflow='';
      currentService = null;
    }

    servicesTbody.addEventListener('click', (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;
      if(t.classList.contains('open-detail') && t.dataset.service){
        openDrawer(t.dataset.service);
      }
    });
    overlay.addEventListener('click', closeDrawer);
    closeSheet.addEventListener('click', closeDrawer);
    closeSheet2.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

    // Recherche drawer
    searchInput.addEventListener('input', ()=>{ if(currentService) buildDetail(currentService); });
    clearSearch.addEventListener('click', ()=>{ searchInput.value=''; searchInput.dispatchEvent(new Event('input')); });

    // Menu outils
    function openMenu(){
      toolsMenu.classList.add('open');
      toolsBtn.setAttribute('aria-expanded','true');
      document.addEventListener('click', outsideClose, { capture:true });
      document.addEventListener('keydown', escClose);
    }
    function closeMenu(){
      toolsMenu.classList.remove('open');
      toolsBtn.setAttribute('aria-expanded','false');
      document.removeEventListener('click', outsideClose, { capture:true });
      document.removeEventListener('keydown', escClose);
    }
    function outsideClose(e){ if(!tools.contains(e.target)) closeMenu(); }
    function escClose(e){ if(e.key==='Escape') closeMenu(); }
    toolsBtn.addEventListener('click', ()=>{ toolsMenu.classList.contains('open') ? closeMenu() : openMenu(); });

    // Export / Import via Remote JSON
    exportJsonBtn.addEventListener('click', async ()=>{
      try{
        const data = await storeLoadAll();
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        const ts=new Date().toISOString().replace(/[:.]/g,'-');
        a.download=`budgets-multi-${ts}.json`;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(a.href),1500);
      }catch(e){ alert('Export impossible (serveur).'); }
      closeMenu();
    });

    importJsonBtn.addEventListener('click', ()=>{ importFile.click(); closeMenu(); });
    importFile.addEventListener('change', async ()=>{
      const f = importFile.files && importFile.files[0];
      if(!f) return;
      const reader=new FileReader();
      reader.onload=async ()=>{
        try{
          const json = JSON.parse(String(reader.result||'{}'));
          const next = (json && json.years) ? json : { years:{} };
          await storeSaveAll(next);
          allData = await storeLoadAll();
          // re-sÃ©lection dâ€™annÃ©e si elle nâ€™existe plus/plus encore
          if(!allData.years[currentYear]){
            const ys = getYears(allData);
            currentYear = ys[ys.length-1] || new Date().getFullYear();
          }
          setYearOptions(currentYear);
          renderList();
          if(currentService) buildDetail(currentService);
          alert('Import terminÃ©.');
        }catch(e){ console.error(e); alert('Import JSON invalide / serveur indisponible.'); }
        importFile.value='';
      };
      reader.readAsText(f);
    });

    // Changement dâ€™annÃ©e (crÃ©ation distante si nÃ©cessaire)
    yearSelect.addEventListener('change', async ()=>{
      if(yearSelect.value===ADD_YEAR_VALUE){
        const y = prompt("Nouvel exercice (YYYY) :", String(new Date().getFullYear()+1));
        const ny = parseInt(y||'',10);
        if(!ny || ny<2000 || ny>9999) return;
        try{
          await updateStore(async (next)=>{ ensureYearStruct(next, ny); });
          allData = await storeLoadAll();
          currentYear = ny;
          setYearOptions(currentYear);
          renderList();
          if(currentService) buildDetail(currentService);
        }catch(e){ console.error(e); alert("CrÃ©ation d'exercice impossible (serveur)."); }
      }else{
        currentYear = Number(yearSelect.value);
        renderList();
        if(currentService) buildDetail(currentService);
      }
    });

    // Init
    (async function init(){
      try{
        allData = await storeLoadAll();
      }catch(e){
        console.error(e);
        alert("Le serveur de donnÃ©es est indisponible.");
        allData = { years:{} };
      }
      let years = getYears(allData);
      if(years.length===0){
        const y = new Date().getFullYear();
        try{ await updateStore(async (next)=>{ ensureYearStruct(next, y); }); }catch(e){}
        allData = await storeLoadAll();
        years = getYears(allData);
      }
      currentYear = years.includes(new Date().getFullYear()) ? new Date().getFullYear() : years[years.length-1];
      setYearOptions(currentYear);
      renderList();
    })();
  })();
  </script>
</body>
</html>
